# Project Journal: Stock Analysis Engine System

> **Purpose**: This file provides Claude with session continuity across conversations. 
> Read this file at the start of every new session to understand current state and context.

---

## Active Context (Updated: 2025-12-29 AEST)

### Current Focus
Architecture upgraded to v4.2 following external architect review and Claude's critical analysis of that feedback. Major additions: valuation bands replacing target prices, provenance metadata on all outputs, evidence registry, sector adapters with gap flagging, explicit Quality thresholds, Decision Engine behavior on WARN, corporate actions logging, API resilience features. Ready to begin implementation.

### Recent Decisions Still in Effect
- **FMP Ultimate plan**: Purchased for 5-6 months â€” primary quantitative data source
- **Data Compiler**: Deterministic Python script with sector adapters â€” pulls FMP data, computes metrics + valuation bands
- **"Engines interpret, not calculate"**: Core architectural principle â€” LLMs never compute financial metrics
- **"No LLM-generated prices"**: Decision Engine outputs valuation zones (UNDERVALUED/FAIR/OVERVALUED), NOT target prices
- **Valuation bands**: Data Compiler computes peer_median_pe_implied, historical_5y_range, conservative_growth_implied
- **Provenance metadata**: ALL engine outputs include `_meta` object with model, prompt_hash, input_hashes, timestamp
- **Evidence registry**: Scout produces structured evidence objects; engines reference by ID (e.g., "E01")
- **Sector adapters**: Data Compiler routes through banks/reits/miners/insurers adapters; gaps flagged not approximated
- **Quality thresholds**: Explicit numeric conditions for PASS/WARN/FAIL defined
- **Decision on WARN**: Max verdict is WATCH; must include confidence_constraints and upgrade_conditions
- **Corporate actions**: Data Compiler logs price_adjustment method and corporate_actions_12m
- **API resilience**: Rate limiting with exponential backoff, 24-hour caching, checkpointing for resume
- **Scout-only web search**: Scout Engine is the ONLY component that searches the web (Perplexity API)
- **Schema validation gates**: JSON schema validation after each engine; fail-fast on validation errors
- **Quality Engine as GATE**: Can BLOCK Decision Engine if audit fails
- **Prompt injection guardrails**: Hard delimiters around all external content
- **Source hierarchy**: FMP (primary) â†’ ASX â†’ Company IR â†’ Perplexity â†’ Reuters/Bloomberg (demoted)
- **Enhanced peer scope**: Local (primary benchmarking) + Global (reference only) + Pure-play
- **Knowledge versioning**: Playbooks now versioned with content hash; regression test suite
- **Engine naming**: All agents called "Engines" with functional names
- **Investment horizon**: Long-only, 1-3 year holding period
- **Short selling**: Descoped from V1
- **No MCP, no RAG**: CLI orchestration, playbooks injected via prompt concatenation

### Immediate Next Steps
1. **User confirms FMP subscription active** â†’ Enables Data Compiler work
2. **User provides FMP API key** â†’ Add to .env
3. **User provides theory PDFs** â†’ Enables Knowledge Curator work
4. Claude creates Data Compiler script with sector adapters and valuation bands
5. Claude creates JSON schemas with _meta provenance for all engine outputs
6. Claude creates Scout Engine with evidence_registry
7. Claude creates Knowledge Curator prompts
8. Project folder setup with new structure

### Open Questions Awaiting Input
- Is FMP Ultimate subscription active?
- FMP API key available?
- Which theory PDFs does user have? (Mentioned: "The Intelligent Investor" + others)

---

## Session History

### Session: 2025-12-29 Evening (Current) â€” Architecture v4.2

#### Summary
Received external architect review of v4.1 architecture. Claude performed critical analysis of the 6 recommendations, agreeing with 5 fully and deferring 1 (full structured evidence objects) to V2. Key outcomes: removed target_price from Decision Engine (replaced with valuation zones), added valuation_bands to Data Compiler, added provenance metadata standard, added evidence_registry to Scout, added sector adapters with explicit gap flagging, defined explicit Quality thresholds, defined Decision Engine behavior on WARN, added corporate actions logging, added API resilience features.

#### Topics & Outcomes

| Topic | Consultant Recommendation | Claude Assessment | Outcome |
|:------|:--------------------------|:------------------|:--------|
| Target price violates "no LLM math" | Remove target_price; Decision chooses among bands | âœ… **AGREE** â€” but consultant fix incomplete | Valuation zones + reference_bands; no target_price |
| Provenance and run metadata | Add model, prompt_hash, input_hashes, timestamps to all outputs | âœ… **STRONGLY AGREE** | `_meta` object on ALL outputs |
| Structured evidence objects | Full metadata per citation | âš ï¸ **DEFER TO V2** â€” over-engineered for V1 | V1: evidence_registry with id, url, retrieved_at, category; V2: full metadata |
| Sector-specific metric gaps | FMP won't have all sector metrics; add adapters | âœ… **STRONGLY AGREE** | Modular sector adapters + gap flagging |
| Quality thresholds WARN vs FAIL | Define explicit conditions and Decision behavior | âœ… **AGREE â€” This was a gap** | Numeric thresholds defined; Decision max WATCH on WARN |
| Corporate actions | Track splits, dividends, adjustment methods | âœ… **AGREE** | price_adjustment + corporate_actions_12m in data_quality |

#### Claude's Additional Identified Gaps (Not in Consultant Feedback)

| Gap | Risk | Recommendation Adopted |
|:----|:-----|:-----------------------|
| Rate limiting / API quotas | FMP Ultimate has call limits; burst runs could fail | Retry with exponential backoff |
| Caching strategy | Re-running analysis for same stock wastes API calls | 24-hour TTL cache |
| Error recovery | Phase fails mid-run, lose all progress | Checkpointing with resume capability |

#### Key Architectural Changes (v4.1 â†’ v4.2)

| Component | v4.1 | v4.2 |
|:----------|:-----|:-----|
| Decision Engine output | target_price ($115.00) | **valuation_zone + reference_bands** |
| Data Compiler valuation | Not computed | **valuation_bands (peer_median, historical, conservative)** |
| Output provenance | Not standardized | **_meta object on ALL outputs** |
| Scout citations | Free-form | **evidence_registry with IDs** |
| Data Compiler structure | Generic | **Sector adapters (banks, REITs, miners, insurers)** |
| Quality thresholds | Implicit | **Explicit numeric conditions** |
| Decision on WARN | Not specified | **Max verdict WATCH; must include upgrade_conditions** |
| Corporate actions | Not tracked | **price_adjustment + corporate_actions_12m** |
| API handling | Not specified | **Rate limiting, 24h cache, checkpointing** |

#### Deliverables Produced

| Artifact | Type | Status |
|:---------|:-----|:-------|
| `stock-analysis-architecture-v4_2.html` | Reference/Visual | âœ… Complete |
| `PROJECT_SUMMARY_2025-12-29_v5.md` | Documentation | âœ… Complete |
| `journal_2025-12-29_v5.md` | Documentation | âœ… Complete (this file) |
| Consultant feedback analysis | Analysis | âœ… Complete |
| v4.1 â†’ v4.2 change mapping | Analysis | âœ… Complete |

#### Key Decisions & Rationale

| Decision | Rationale | Implications |
|:---------|:----------|:-------------|
| **Remove target_price from Decision Engine** | LLMs should not generate prices; violates "interpret, not calculate" | Decision outputs valuation_zone (UNDERVALUED/FAIR/OVERVALUED) + entry_thesis |
| **Add valuation_bands to Data Compiler** | Deterministic reference points replace LLM-generated prices | peer_median_pe_implied, historical_5y_range, conservative_growth_implied |
| **Add _meta provenance to all outputs** | Reproducibility + audit trail for investment decisions | model, prompt_hash, input_hashes, generated_at on every JSON |
| **Defer full evidence metadata to V2** | Extracting publisher, published_date requires additional web fetches | V1: id, url, retrieved_at, category_hint; V2: full metadata |
| **Sector adapters with gap flagging** | FMP doesn't have all sector metrics (CET1, AISC, etc.) | Adapters for banks/REITs/miners/insurers; gaps flagged in sector_gaps |
| **Explicit Quality thresholds** | Was a gap â€” implicit PASS/WARN/FAIL not operational | Numeric conditions defined (e.g., >1% metric mismatch = FAIL) |
| **Decision constrained on WARN** | Prevents overconfident outputs with thin evidence | Max verdict WATCH; must explain upgrade_conditions |
| **Corporate actions logging** | Multi-year return calculations affected by splits/dividends | price_adjustment method + corporate_actions_12m |
| **API resilience features** | Production robustness for re-runs and failures | Rate limiting, 24h cache, checkpointing |

#### Outstanding Items

| Item | Priority | Owner | Next Action |
|:-----|:---------|:------|:------------|
| Confirm FMP subscription active | ðŸ”´ High | User | Verify subscription |
| Provide FMP API key | ðŸ”´ High | User | Share key or add to .env |
| Provide theory PDFs | ðŸ”´ High | User | Upload/share PDF files |
| Create Data Compiler with sector adapters | ðŸ”´ High | Claude | After FMP confirmed |
| Create JSON schemas with _meta | ðŸ”´ High | Claude | Can start now |
| Create Scout Engine with evidence_registry | ðŸ”´ High | Claude | After schemas ready |
| Create Knowledge Curator prompts | ðŸ”´ High | Claude | After PDFs received |
| Set up project folder | ðŸ”´ High | User | After components ready |
| Define investment philosophy | ðŸŸ¡ Med | User | For Decision Engine |
| Define decision rules/weights | ðŸŸ¡ Med | User | For Decision Engine |

---

### Session: 2025-12-29 Morning â€” Architecture v4.1

#### Summary
Incorporated OpenAI ChatGPT architect P0/P1 recommendations into architecture. User decided to purchase FMP Ultimate plan for 5-6 months. This fundamentally changed the data strategy â€” FMP becomes primary quantitative source, enabling "engines interpret, not calculate" principle. Added Data Compiler as deterministic script. Consolidated all web search to Scout Engine only. Added JSON schema validation gates with fail-fast behavior. Added prompt injection guardrails. Enhanced peer scope to include global context. Added Knowledge Curator versioning and regression tests.

#### Topics & Outcomes

| Topic | Context | Conclusion |
|:------|:--------|:-----------|
| OpenAI P0-1: Deterministic data layer | LLMs should not calculate from narrative | Added Data Compiler (Python script, FMP API) |
| FMP Ultimate decision | User decided to pay for FMP | Primary quantitative data source; enables ASX coverage |
| OpenAI P0-2: Web search consistency | Mixed search (Scout + Catalyst + Geopolitics) is fragile | Scout Engine is now the ONLY search component |
| OpenAI P0-3: Source hardening | Paywalled outlets reduce reproducibility | FMP primary; Reuters/Bloomberg demoted to "nice-to-have" |
| OpenAI P0-4: Schema gating | No failure behavior defined | JSON schema validation gates; Quality can BLOCK Decision |
| OpenAI P0-5: Prompt injection | Concatenating web text is dangerous | Hard delimiters; "UNTRUSTED REFERENCE" wrapper |
| OpenAI P1-1: Peer scope fallback | "Local only" breaks for some sectors | Local (primary) + Global (reference) + Pure-play |
| OpenAI P1-2: Knowledge versioning | No regression checks | Added version metadata + regression test suite |

---

### Session: 2025-12-23

#### Summary
Incorporated recommendations from OpenAI ChatGPT architect review (initial). Major changes: renamed all agents to engines with functional names, added Knowledge Curator as new Phase -1, defined knowledge architecture with playbook structure and assignment matrix, added orchestrator knowledge selection, explicitly defined investment horizon (1-3 years, long-only), descoped short selling, added explicit news sourcing, upgraded Catalyst Engine to structured output, upgraded Quality Engine with audit methodology.

---

### Session: 2025-12-22 ~14:00-19:30 AEST

#### Summary
Comprehensive design session establishing the stock analysis agent architecture. Started with concept validation, evolved through V2 framework (17 sections), defined 8-agent architecture with GPT Decision Engine, then added Agent 0 (Discovery) using Perplexity API. Produced project summary v1/v2, architecture documentation v2/v3, and project journal v1/v2.

#### Key Decisions Made
- Perplexity API over Gemini CLI for Agent 0 (mandatory citations)
- `sonar-reasoning-pro` model for deep research
- Dual output (JSON + MD) for all agents
- Local peers only (no global) â€” *later updated in v4.1*
- All exchanges in country included
- No MCP, no RAG for V1
- GPT as Decision Engine (separate from analysis)

---

## Reference: Component Registry (v4.2)

| Component | Type | Role | Platform | Output |
|:----------|:-----|:-----|:---------|:-------|
| Knowledge Curator | LLM | Extract theory â†’ versioned playbooks | GPT | `knowledge/*.md` |
| Scout Engine | LLM + Search | Discovery, peers, news, policy, evidence_registry (ONLY search) | Perplexity | `00_scout.json` |
| **Data Compiler** | **Script** | FMP data, sector adapters, valuation bands, corporate actions (NO LLM) | Python + FMP | `00_data_pack.json` |
| Fundamentals Engine | LLM | Interpret financials (Â§0-7) | Claude | `01_fundamentals.json` |
| Supply Chain Engine | LLM | Value chain (Â§11) | Claude | `02_supply_chain.json` |
| Contrarian Engine | LLM | Challenge consensus (Â§10,13,15) | Claude | `03_contrarian.json` |
| Geopolitics Engine | LLM | Policy & scenarios (Â§12) | Claude | `04_geopolitics.json` |
| Peer Benchmark Engine | LLM | Peer comparison | Claude | `05_peer_benchmark.json` |
| Governance Engine | LLM | Management (Â§8-9) | Claude | `06_governance.json` |
| Catalyst Engine | LLM | Event tracking (Â§14) | Claude | `07_catalysts.json` |
| Quality Engine | LLM | Audit with explicit thresholds + GATE function | Claude | `08_quality.json` |
| Decision Engine | LLM | Valuation zone verdict (no target prices) | GPT | `09_decision.json` |

**Total: 12 components** = 1 Knowledge Curator + 1 Scout + 1 Data Compiler (script) + 8 Claude engines + 1 Decision Engine. All outputs include `_meta` provenance.

---

## Reference: Phase Structure (v4.2)

```
Phase -1: Knowledge Curation (one-time)
â””â”€â”€ Knowledge Curator (GPT)
    â””â”€â”€ Input: Theory PDFs â†’ Output: knowledge/*.md (versioned)

Phase 0: Discovery + Data (per-stock)
â”œâ”€â”€ Step 0A: Scout Engine (Perplexity) â€” ONLY web search component
â”‚   â””â”€â”€ Input: Ticker â†’ Output: 00_scout.json
â”‚   â””â”€â”€ Includes: peers, sector_lens, knowledge_packs, news, policy_context
â”‚   â””â”€â”€ NEW: evidence_registry (structured citations)
â”‚
â””â”€â”€ Step 0B: Data Compiler (Deterministic Python Script)
    â””â”€â”€ Input: 00_scout.json â†’ Output: 00_data_pack.json
    â””â”€â”€ Source: FMP API with sector adapters
    â””â”€â”€ Computes: All financial metrics, peer comparisons
    â””â”€â”€ NEW: valuation_bands, corporate_actions_12m

Phase 1: Foundation
â””â”€â”€ Fundamentals + Peer Benchmark (parallel)
    â””â”€â”€ Consumes: 00_scout.json + 00_data_pack.json + playbooks
    â””â”€â”€ Interprets data; NEVER calculates
    â””â”€â”€ ALL outputs include _meta provenance

Phase 2: Context
â””â”€â”€ Governance + Supply Chain + Catalyst (parallel)
    â””â”€â”€ Catalyst uses Scout's evidence_registry (no web search)

Phase 3: Analysis
â””â”€â”€ Geopolitics â†’ Contrarian (sequential)
    â””â”€â”€ Geopolitics uses Scout's policy context (no web search)

Phase 4: Synthesis
â””â”€â”€ Quality â†’ Decision (sequential, GATED)
    â””â”€â”€ Quality: Explicit thresholds for PASS/WARN/FAIL
    â””â”€â”€ Quality can BLOCK Decision if audit fails
    â””â”€â”€ Decision on WARN: Max verdict WATCH; must include upgrade_conditions
    â””â”€â”€ Decision: Valuation zone verdict (no target_price)
```

---

## Reference: Quality Thresholds (v4.2)

| Condition | Result | Rationale |
|:----------|:-------|:----------|
| Any metric differs from data_pack by >1% | **FAIL** | Prevents hallucinated numbers |
| Required section missing | **FAIL** | Incomplete analysis |
| Evidence coverage <50% | **FAIL** | Insufficient support |
| Core financial data >90 days stale | **FAIL** | Outdated analysis |
| Evidence coverage 50-75% | **WARN** | Thin but acceptable |
| Data staleness 30-90 days | **WARN** | Usable but flag |
| Peer set <3 local comparables | **WARN** | Low confidence |
| Sector adapter flagged gaps | **WARN** | Missing context |

**Decision on WARN:** Max verdict WATCH; must include confidence_constraints and upgrade_conditions.

---

## Reference: Source Hierarchy (v4.2)

| Priority | Source | Type | Usage |
|:---------|:-------|:-----|:------|
| 1 | FMP API | Quantitative | Financial statements, ratios, metrics â€” **PRIMARY** |
| 2 | ASX Announcements | Official | Material disclosures, filings |
| 3 | Company IR | Official | Annual reports, presentations, transcripts |
| 4 | Regulators/Filings | Official | ASIC, RBA, regulatory calendars |
| 5 | Perplexity (Scout) | Qualitative | News, sector context, policy developments |
| 6 | Reuters/Bloomberg | Qualitative | Validation only â€” **NOT dependency** |

---

## Reference: Key v4.2 Changes Summary

| Change | Before (v4.1) | After (v4.2) |
|:-------|:--------------|:-------------|
| Decision output | target_price | valuation_zone + reference_bands |
| Valuation bands | Not computed | Data Compiler produces |
| Provenance | Not standardized | _meta on ALL outputs |
| Citations | Free-form | evidence_registry with IDs |
| Sector handling | Generic | Modular adapters + gap flagging |
| Quality thresholds | Implicit | Explicit numeric |
| Decision on WARN | Not specified | Max WATCH + upgrade_conditions |
| Corporate actions | Not tracked | price_adjustment + 12m actions |
| API resilience | Not specified | Rate limit, cache, checkpoint |

---

## Reference: Key Documents

| Document | Version | Location |
|:---------|:--------|:---------|
| V2 Framework | â€” | `stock_analysisv2.md` |
| Architecture Doc | v4.2 | `stock-analysis-architecture-v4_2.html` |
| Project Summary | v5 | `PROJECT_SUMMARY_2025-12-29_v5.md` |
| This Journal | v5 | `journal_2025-12-29_v5.md` |

---

## Behavior Rules

- **Active Context**: ALWAYS update this section to reflect the latest state
- **Append, don't replace**: Add new session entries; never delete historical entries
- **Session order**: Most recent session appears directly under Active Context
- **Be specific**: Include file names, exact decisions, specific blockers
- **Assume fresh start**: Write as if Claude has zero memory beyond this document
- **Include "why"**: Decisions without rationale force re-discussion

---

*End of Journal v5*
